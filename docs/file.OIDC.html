<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: OIDC
  
    &mdash; Documentation by YARD 0.9.37
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "OIDC";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: OIDC</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="openid-connect-oidc-with-ruby-oauthoauth2">OpenID Connect (OIDC) with ruby-oauth/oauth2</h1>

<h2 id="oidc-libraries">OIDC Libraries</h2>

<p>Libraries built on top of the oauth2 gem that implement OIDC.</p>

<ul>
  <li>
<a href="https://github.com/amco/gamora-rb">gamora</a> - OpenID Connect Relying Party for Rails apps</li>
  <li>
<a href="https://github.com/doximity/omniauth-doximity-oauth2">omniauth-doximity-oauth2</a> - OmniAuth strategy for Doximity, supporting OIDC, and using PKCE</li>
  <li>
<a href="https://github.com/sorah/himari">omniauth-himari</a> - OmniAuth strategy to act as OIDC RP and use <a href="https://github.com/sorah/himari">Himari</a> for OP</li>
  <li>
<a href="https://github.com/MITLibraries/omniauth-mit-oauth2">omniauth-mit-oauth2</a> - OmniAuth strategy for MIT OIDC</li>
</ul>

<p>If any other libraries would like to be added to this list, please open an issue or pull request.</p>

<h2 id="raw-oidc-with-ruby-oauthoauth2">Raw OIDC with ruby-oauth/oauth2</h2>

<p>This document complements the inline documentation by focusing on OpenID Connect (OIDC) 1.0 usage patterns when using this gem as an OAuth 2.0 client library.</p>

<p>Scope of this document</p>
<ul>
  <li>Audience: Developers building an OAuth 2.0/OIDC Relying Party (RP, aka client) in Ruby.</li>
  <li>Non-goals: This gem does not implement an OIDC Provider (OP, aka Authorization Server); for OP/server see other projects (e.g., doorkeeper + oidc extensions).</li>
  <li>Status: Informational documentation with links to normative specs. The gem intentionally remains protocol-agnostic beyond OAuth 2.0; OIDC specifics (like ID Token validation) must be handled by your application.</li>
</ul>

<p>Key concepts refresher</p>
<ul>
  <li>OAuth 2.0 delegates authorization; it does not define authentication of the end-user.</li>
  <li>OIDC layers an identity layer on top of OAuth 2.0, introducing:
    <ul>
      <li>ID Token: a JWT carrying claims about the authenticated end-user and the authentication event.</li>
      <li>Standardized scopes: openid (mandatory), profile, email, address, phone, offline_access, and others.</li>
      <li>UserInfo endpoint: a protected resource for retrieving user profile claims.</li>
      <li>Discovery and Dynamic Client Registration (optional for providers/clients that support them).</li>
    </ul>
  </li>
</ul>

<p>What this gem provides for OIDC</p>
<ul>
  <li>All OAuth 2.0 client capabilities required for OIDC flows: building authorization requests, exchanging authorization codes, refreshing tokens, and making authenticated resource requests.</li>
  <li>Transport and parsing conveniences (snaky hash, Faraday integration, error handling, etc.).</li>
  <li>Optional client authentication schemes useful with OIDC deployments:
    <ul>
      <li>basic_auth (default)</li>
      <li>request_body (legacy)</li>
      <li>tls_client_auth (MTLS)</li>
      <li>private_key_jwt (OIDC-compliant when configured per OP requirements)</li>
    </ul>
  </li>
</ul>

<p>What you must add in your app for OIDC</p>
<ul>
  <li>ID Token validation: This gem surfaces id_token values but does not verify them. Your app should:<br>
1) Parse the JWT (header, payload, signature)<br>
2) Fetch the OP JSON Web Key Set (JWKS) from discovery (or configure statically)<br>
3) Select the correct key by kid (when present) and verify the signature and algorithm<br>
4) Validate standard claims (iss, aud, exp, iat, nbf, azp, nonce when used, at_hash/c_hash when applicable)<br>
5) Enforce expected client_id, issuer, and clock skew policies</li>
  <li>Nonce handling for Authorization Code flow with OIDC: generate a cryptographically-random nonce, bind it to the user session before redirect, include it in authorize request, and verify it in the ID Token on return.</li>
  <li>PKCE is best practice and often required by OPs: generate/verifier, send challenge in authorize, send verifier in token request.</li>
  <li>Session/state management: continue to validate state to mitigate CSRF; use exact redirect_uri matching.</li>
</ul>

<p>Minimal OIDC Authorization Code example</p>

<pre class="code language-ruby"><code class="language-ruby">require &quot;oauth2&quot;
require &quot;jwt&quot;         # jwt/ruby-jwt
require &quot;net/http&quot;
require &quot;json&quot;

client = OAuth2::Client.new(
  ENV.fetch(&quot;OIDC_CLIENT_ID&quot;),
  ENV.fetch(&quot;OIDC_CLIENT_SECRET&quot;),
  site: ENV.fetch(&quot;OIDC_ISSUER&quot;),              # e.g. https://accounts.example.com
  authorize_url: &quot;/authorize&quot;,                 # or discovered
  token_url: &quot;/token&quot;,                         # or discovered
)

# Step 1: Redirect to OP for consent/auth
state = SecureRandom.hex(16)
nonce = SecureRandom.hex(16)
pkce_verifier = SecureRandom.urlsafe_base64(64)
pkce_challenge = Base64.urlsafe_encode64(Digest::SHA256.digest(pkce_verifier)).delete(&quot;=&quot;)

authz_url = client.auth_code.authorize_url(
  scope: &quot;openid profile email&quot;,
  state: state,
  nonce: nonce,
  code_challenge: pkce_challenge,
  code_challenge_method: &quot;S256&quot;,
  redirect_uri: ENV.fetch(&quot;OIDC_REDIRECT_URI&quot;),
)
# redirect_to authz_url

# Step 2: Handle callback
# params[:code], params[:state]
raise &quot;state mismatch&quot; unless params[:state] == state

token = client.auth_code.get_token(
  params[:code],
  redirect_uri: ENV.fetch(&quot;OIDC_REDIRECT_URI&quot;),
  code_verifier: pkce_verifier,
)

# The token may include: access_token, id_token, refresh_token, etc.
id_token = token.params[&quot;id_token&quot;] || token.params[:id_token]

# Step 3: Validate the ID Token (simplified – add your own checks!)
# Discover keys (example using .well-known)
issuer = ENV.fetch(&quot;OIDC_ISSUER&quot;)
jwks_uri = JSON.parse(Net::HTTP.get(URI.join(issuer, &quot;/.well-known/openid-configuration&quot;))).
  fetch(&quot;jwks_uri&quot;)
jwks = JSON.parse(Net::HTTP.get(URI(jwks_uri)))
keys = jwks.fetch(&quot;keys&quot;)

# Use ruby-jwt JWK loader
jwk_set = JWT::JWK::Set.new(keys.map { |k| JWT::JWK.import(k) })

decoded, headers = JWT.decode(
  id_token,
  nil,
  true,
  algorithms: [&quot;RS256&quot;, &quot;ES256&quot;, &quot;PS256&quot;],
  jwks: jwk_set,
  verify_iss: true,
  iss: issuer,
  verify_aud: true,
  aud: ENV.fetch(&quot;OIDC_CLIENT_ID&quot;),
)

# Verify nonce
raise &quot;nonce mismatch&quot; unless decoded[&quot;nonce&quot;] == nonce

# Optionally: call UserInfo
userinfo = token.get(&quot;/userinfo&quot;).parsed
</code></pre>

<p>Notes on discovery and registration</p>
<ul>
  <li>Discovery: Most OPs publish configuration at issuer/.well-known/openid-configuration (OIDC Discovery 1.0). From there, resolve authorization_endpoint, token_endpoint, jwks_uri, userinfo_endpoint, etc.</li>
  <li>Dynamic Client Registration: Some OPs allow registering clients programmatically (OIDC Dynamic Client Registration 1.0). This gem does not implement registration; use a plain HTTP client or Faraday and store credentials securely.</li>
</ul>

<p>Common pitfalls and tips</p>
<ul>
  <li>Always request the openid scope when you expect an ID Token. Without it, the OP may behave as vanilla OAuth 2.0.</li>
  <li>Validate ID Token signature and claims before trusting any identity data. Do not rely solely on the presence of an id_token field.</li>
  <li>Prefer Authorization Code + PKCE. Avoid Implicit; it is discouraged in modern guidance and may be disabled by providers.</li>
  <li>Use exact redirect_uri matching, and keep your allow-list short.</li>
  <li>For public clients that use refresh tokens, prefer sender-constrained tokens (DPoP/MTLS) or rotation with one-time-use refresh tokens, per modern best practices.</li>
  <li>When using private_key_jwt, ensure the “aud” (or token_url) and “iss/sub” claims are set per the OP’s rules, and include kid in the JWT header when required so the OP can select the right key.</li>
</ul>

<p>Relevant specifications and references</p>
<ul>
  <li>OpenID Connect Core 1.0: https://openid.net/specs/openid-connect-core-1_0.html</li>
  <li>OIDC Core (final): https://openid.net/specs/openid-connect-core-1_0-final.html</li>
  <li>How OIDC works: https://openid.net/developers/how-connect-works/</li>
  <li>OpenID Connect home: https://openid.net/connect/</li>
  <li>OIDC Discovery 1.0: https://openid.net/specs/openid-connect-discovery-1_0.html</li>
  <li>OIDC Dynamic Client Registration 1.0: https://openid.net/specs/openid-connect-registration-1_0.html</li>
  <li>OIDC Session Management 1.0: https://openid.net/specs/openid-connect-session-1_0.html</li>
  <li>OIDC RP-Initiated Logout 1.0: https://openid.net/specs/openid-connect-rpinitiated-1_0.html</li>
  <li>OIDC Back-Channel Logout 1.0: https://openid.net/specs/openid-connect-backchannel-1_0.html</li>
  <li>OIDC Front-Channel Logout 1.0: https://openid.net/specs/openid-connect-frontchannel-1_0.html</li>
  <li>Auth0 OIDC overview: https://auth0.com/docs/authenticate/protocols/openid-connect-protocol</li>
  <li>Spring Authorization Server’s list of OAuth2/OIDC specs: https://github.com/spring-projects/spring-authorization-server/wiki/OAuth2-and-OIDC-Specifications</li>
</ul>

<p>See also</p>
<ul>
  <li>README sections on OAuth 2.1 notes and OIDC notes</li>
  <li>Strategy classes under lib/oauth2/strategy for flow helpers</li>
  <li>Specs under spec/oauth2 for concrete usage patterns</li>
</ul>

<p>Contributions welcome</p>
<ul>
  <li>If you discover provider-specific nuances, consider contributing examples or clarifications (without embedding provider-specific hacks into the library).</li>
</ul>
</div></div>

      <div id="footer">
  Generated on Thu Sep 25 11:50:27 2025 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.37 (ruby-3.4.5).
</div>

    </div>
  </body>
</html>